<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–í—ã–±–æ—Ä –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            padding: 16px;
        }

        .container {
            max-width: 100%;
            padding-bottom: 80px;
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
            padding: 20px;
            background: var(--tg-theme-secondary-bg-color, #f0f0f0);
            border-radius: 12px;
        }

        .header h1 {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .header p {
            font-size: 14px;
            color: var(--tg-theme-hint-color, #999999);
        }

        .selected-info {
            margin-bottom: 20px;
            padding: 16px;
            background: var(--tg-theme-secondary-bg-color, #f0f0f0);
            border-radius: 12px;
        }

        .selected-item {
            margin-bottom: 8px;
            font-size: 14px;
        }

        .selected-label {
            color: var(--tg-theme-hint-color, #666666);
        }

        .selected-value {
            font-weight: 600;
            color: var(--tg-theme-button-color, #2481cc);
            margin-left: 5px;
        }

        .search-section {
            margin-bottom: 20px;
        }

        .search-input {
            width: 100%;
            padding: 14px;
            border: 2px solid var(--tg-theme-secondary-bg-color, #f0f0f0);
            border-radius: 12px;
            font-size: 16px;
            margin-bottom: 10px;
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
        }

        .search-input:focus {
            outline: none;
            border-color: var(--tg-theme-button-color, #2481cc);
        }

        .organizations-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }

        .organization-button {
            padding: 16px 8px;
            border: none;
            border-radius: 12px;
            background: var(--tg-theme-secondary-bg-color, #f0f0f0);
            color: var(--tg-theme-text-color, #000000);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            word-break: break-word;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .organization-button:hover {
            background: var(--tg-theme-hint-color, #e0e0e0);
        }

        .organization-button.selected {
            background: var(--tg-theme-button-color, #2481cc);
            color: var(--tg-theme-button-text-color, #ffffff);
        }

        .department-selection {
            margin-bottom: 20px;
            padding: 20px;
            background: var(--tg-theme-secondary-bg-color, #f0f0f0);
            border-radius: 12px;
        }

        .department-header {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 15px;
            text-align: center;
        }

        .departments-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 8px;
            margin-bottom: 15px;
        }

        .department-button {
            padding: 12px 8px;
            border: none;
            border-radius: 8px;
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .department-button:hover {
            background: var(--tg-theme-hint-color, #f5f5f5);
        }

        .department-button.selected {
            background: var(--tg-theme-button-color, #2481cc);
            color: var(--tg-theme-button-text-color, #ffffff);
        }

        .custom-input-section {
            margin-bottom: 20px;
            padding: 20px;
            background: var(--tg-theme-secondary-bg-color, #f0f0f0);
            border-radius: 12px;
        }

        .custom-input-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 15px;
            text-align: center;
        }

        .custom-input {
            width: 100%;
            padding: 14px;
            border: 2px solid var(--tg-theme-secondary-bg-color, #ddd);
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 15px;
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
        }

        .custom-input:focus {
            outline: none;
            border-color: var(--tg-theme-button-color, #2481cc);
        }

        .custom-input-note {
            font-size: 12px;
            color: var(--tg-theme-hint-color, #666666);
            text-align: center;
            margin-top: 10px;
        }

        .actions {
            display: flex;
            gap: 12px;
            position: fixed;
            bottom: 16px;
            left: 16px;
            right: 16px;
            background: var(--tg-theme-bg-color, #ffffff);
            padding: 10px 0;
        }

        .action-button {
            flex: 1;
            padding: 16px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .action-button:active {
            transform: scale(0.95);
        }

        .confirm {
            background: var(--tg-theme-button-color, #2481cc);
            color: var(--tg-theme-button-text-color, #ffffff);
        }

        .cancel {
            background: var(--tg-theme-secondary-bg-color, #f0f0f0);
            color: var(--tg-theme-text-color, #000000);
        }

        .confirm:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .confirm:disabled:active {
            transform: none;
        }

        .show-full-list {
            display: block;
            width: 100%;
            margin: 20px auto;
            padding: 12px 24px;
            background: var(--tg-theme-secondary-bg-color, #f0f0f0);
            color: var(--tg-theme-text-color, #000000);
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .show-full-list:hover {
            background: var(--tg-theme-hint-color, #e0e0e0);
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 16px;
        }

        .modal-content {
            background: var(--tg-theme-bg-color, #ffffff);
            border-radius: 16px;
            padding: 20px;
            max-width: 500px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--tg-theme-secondary-bg-color, #f0f0f0);
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            color: var(--tg-theme-text-color, #000000);
            cursor: pointer;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
        }

        .modal-close:hover {
            background: var(--tg-theme-secondary-bg-color, #f0f0f0);
        }

        .full-list-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 8px;
        }

        .full-list-button {
            padding: 12px 8px;
            border: none;
            border-radius: 8px;
            background: var(--tg-theme-secondary-bg-color, #f0f0f0);
            color: var(--tg-theme-text-color, #000000);
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .full-list-button:hover {
            background: var(--tg-theme-hint-color, #e0e0e0);
        }

        .full-list-button.selected {
            background: var(--tg-theme-button-color, #2481cc);
            color: var(--tg-theme-button-text-color, #ffffff);
        }

        @media (max-width: 480px) {
            .organizations-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .departments-grid {
                grid-template-columns: 1fr;
            }

            .full-list-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>–í—ã–±–æ—Ä –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏</h1>
            <p>–í—ã–±–µ—Ä–∏—Ç–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—é –∏–∑ —Å–ø–∏—Å–∫–∞ –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ —Å–≤–æ—é</p>
        </div>

        <div class="selected-info">
            <div class="selected-item">
                <span class="selected-label">–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è:</span>
                <span class="selected-value" id="selectedOrganization">–Ω–µ –≤—ã–±—Ä–∞–Ω–∞</span>
            </div>
            <div class="selected-item" id="selectedDepartmentItem" style="display: none;">
                <span class="selected-label">–ü–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ:</span>
                <span class="selected-value" id="selectedDepartment">–Ω–µ –≤—ã–±—Ä–∞–Ω–æ</span>
            </div>
            <div class="selected-item" id="selectedCustomItem" style="display: none;">
                <span class="selected-label">–°–≤–æ—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è:</span>
                <span class="selected-value" id="selectedCustom">–Ω–µ –≤–≤–µ–¥–µ–Ω–∞</span>
            </div>
        </div>

        <div class="search-section">
            <input type="text"
                   class="search-input"
                   placeholder="üîç –ü–æ–∏—Å–∫ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏..."
                   id="searchInput"
                   onkeyup="filterOrganizations()">
        </div>

        <div class="organizations-grid" id="organizationsGrid">
            <!-- –û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã —á–µ—Ä–µ–∑ JS -->
        </div>

        <div class="department-selection" id="departmentSelection" style="display: none;">
            <div class="department-header" id="departmentHeader">–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ:</div>
            <div class="departments-grid" id="departmentsGrid">
                <!-- –ü–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã —á–µ—Ä–µ–∑ JS -->
            </div>
            <div class="custom-input-note">
                –ò–ª–∏ –≤–≤–µ–¥–∏—Ç–µ —Å–≤–æ–µ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –Ω–∏–∂–µ
            </div>
            <input type="text"
                   class="custom-input"
                   placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–≤–æ–µ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ"
                   id="customDepartmentInput"
                   oninput="updateCustomDepartment()">
        </div>

        <div class="custom-input-section">
            <div class="custom-input-title">–ù–µ –Ω–∞—à–ª–∏ —Å–≤–æ—é –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—é?</div>
            <input type="text"
                   class="custom-input"
                   placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Å–≤–æ–µ–π –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏"
                   id="customOrganizationInput"
                   oninput="updateCustomOrganization()">
            <div class="custom-input-note">
                –í–∞—à–∞ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ —Å–ø–∏—Å–æ–∫ –≤—ã–±–æ—Ä–∞
            </div>
        </div>

        <button class="show-full-list" onclick="showFullList()">–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏</button>
    </div>

    <div class="actions">
        <button class="action-button cancel" onclick="cancelSelection()">–û—Ç–º–µ–Ω–∞</button>
        <button class="action-button confirm" id="confirmButton" onclick="confirmSelection()" disabled>–í—ã–±—Ä–∞—Ç—å</button>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ —Å–ø–∏—Å–∫–∞ -->
    <div class="modal-overlay" id="fullListModal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">–í—Å–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏</div>
                <button class="modal-close" onclick="hideFullList()">√ó</button>
            </div>
            <div class="full-list-grid" id="fullListGrid">
                <!-- –í—Å–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã —á–µ—Ä–µ–∑ JS -->
            </div>
        </div>
    </div>

    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram Web App
        Telegram.WebApp.ready();
        Telegram.WebApp.expand();

        // –ü–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è –¥–ª—è –°–ø–µ—Ü—Å—Ç—Ä–æ—è
        const specstroyDepartments = [
            "–°—Ç—Ä–æ–∏—Ç–µ–ª—å–Ω–æ-–º–æ–Ω—Ç–∞–∂–Ω—ã–π —É—á–∞—Å—Ç–æ–∫ - 1",
            "–°—Ç—Ä–æ–∏—Ç–µ–ª—å–Ω–æ-–º–æ–Ω—Ç–∞–∂–Ω—ã–π —É—á–∞—Å—Ç–æ–∫ - 2",
            "–°—Ç—Ä–æ–∏—Ç–µ–ª—å–Ω–æ-–º–æ–Ω—Ç–∞–∂–Ω—ã–π —É—á–∞—Å—Ç–æ–∫ - 3",
            "–°—Ç—Ä–æ–∏—Ç–µ–ª—å–Ω–æ-–º–æ–Ω—Ç–∞–∂–Ω—ã–π —É—á–∞—Å—Ç–æ–∫ - 4",
            "–£—á–∞—Å—Ç–æ–∫ –ø–æ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—é –≥—Ä—É–∑–æ–ø–æ–¥—ä–µ–º–Ω—ã—Ö –º–µ—Ö–∞–Ω–∏–∑–º–æ–≤",
            "–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω—ã–π —É—á–∞—Å—Ç–æ–∫",
            "–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω–æ-—É–ø—Ä–∞–≤–ª–µ–Ω—á–µ—Å–∫–æ–µ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ",
            "–°—Ç—Ä–æ–∏—Ç–µ–ª—å–Ω–æ-–º–æ–Ω—Ç–∞–∂–Ω—ã–π —É—á–∞—Å—Ç–æ–∫ (–ê–£–ü)",
            "–ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω–æ-—Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –æ—Ç–¥–µ–ª",
            "–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω–æ-—Ö–æ–∑—è–π—Å—Ç–≤–µ–Ω–Ω—ã–π –æ—Ç–¥–µ–ª",
            "–û—Ç–¥–µ–ª –≥–ª–∞–≤–Ω–æ–≥–æ —ç–Ω–µ—Ä–≥–µ—Ç–∏–∫–∞",
            "–°–ª—É–∂–±–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏"
        ];

        // –ü–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è –¥–ª—è –°–ø–µ—Ü—Å—Ç—Ä–æ–π-–ù–°–ö
        const specstroyNskDepartments = [
            "–°—Ç—Ä–æ–∏—Ç–µ–ª—å–Ω–æ-–º–æ–Ω—Ç–∞–∂–Ω—ã–π —É—á–∞—Å—Ç–æ–∫ - 1",
            "–°—Ç—Ä–æ–∏—Ç–µ–ª—å–Ω–æ-–º–æ–Ω—Ç–∞–∂–Ω—ã–π —É—á–∞—Å—Ç–æ–∫ - 2",
            "–°—Ç—Ä–æ–∏—Ç–µ–ª—å–Ω–æ-–º–æ–Ω—Ç–∞–∂–Ω—ã–π —É—á–∞—Å—Ç–æ–∫ - 3",
            "–°—Ç—Ä–æ–∏—Ç–µ–ª—å–Ω–æ-–º–æ–Ω—Ç–∞–∂–Ω—ã–π —É—á–∞—Å—Ç–æ–∫ - 4",
            "–£—á–∞—Å—Ç–æ–∫ –ø–æ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—é –≥—Ä—É–∑–æ–ø–æ–¥—ä–µ–º–Ω—ã—Ö –º–µ—Ö–∞–Ω–∏–∑–º–æ–≤",
            "–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω—ã–π —É—á–∞—Å—Ç–æ–∫",
            "–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω–æ-—É–ø—Ä–∞–≤–ª–µ–Ω—á–µ—Å–∫–æ–µ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ",
            "–°—Ç—Ä–æ–∏—Ç–µ–ª—å–Ω–æ-–º–æ–Ω—Ç–∞–∂–Ω—ã–π —É—á–∞—Å—Ç–æ–∫ (–ê–£–ü)",
            "–ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω–æ-—Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –æ—Ç–¥–µ–ª",
            "–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω–æ-—Ö–æ–∑—è–π—Å—Ç–≤–µ–Ω–Ω—ã–π –æ—Ç–¥–µ–ª",
            "–û—Ç–¥–µ–ª –≥–ª–∞–≤–Ω–æ–≥–æ —ç–Ω–µ—Ä–≥–µ—Ç–∏–∫–∞",
            "–°–ª—É–∂–±–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏"
        ];

        // –î–∞–Ω–Ω—ã–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π
        const organizations = [
            "–ì–ö –°–æ—é–∑",
            "–°–æ—é–∑-–ò–Ω–≤–µ—Å—Ç",
            {
                name: "–°–ø–µ—Ü—Å—Ç—Ä–æ–π",
                hasDepartments: true,
                departments: specstroyDepartments
            },
            {
                name: "–°–ø–µ—Ü—Å—Ç—Ä–æ–π-–ù–°–ö",
                hasDepartments: true,
                departments: specstroyNskDepartments
            },
            "–°–æ—é–∑-–ò–Ω–∂–∏–Ω–∏—Ä–∏–Ω–≥",
            "–°–æ—é–∑-–º–∞—Ä–∫–µ—Ç",
            "–û–ø–æ—Ä–∞",
            "–í–µ—Ä—Ç–∏–∫–∞–ª—å",
            "–°–ø–µ—Ü—Ç–µ—Ö–Ω–∏–∫–∞",
            "–°–∏–ª–∞ —Ç–æ–∫–∞",
            "–û–ú–¢–°",
            "–ê–ª—å—Ç—Å—Ç—Ä–æ–π",
            "–ù–ö–ñ–ë–ò-2",
            "–ó–ö–ú –°–æ—é–∑",
            "–ñ–ë–ò –ù–°–ö",
            "–°—Ç—Ä–æ–π—Ü–µ–Ω—Ç—Ä",
            "–Æ–Ω–∏–æ–Ω-–º–µ—Ç–∞–ª",
            "–ò–ü –ú–µ–ª—å–Ω–∏–∫",
            "–ò–ü –ú–µ–ª–µ—Ö–æ–≤",
            "–ú–µ–ª–µ—Ö–æ–≤ (–¥–æ–ø)",
            "–ò–ü –Ø—Ä–æ—Ö",
            "–ò–ü –¢–∞—Ä–∞—Å–æ–≤",
            "–ò–ü –¢–æ–ª—Å—Ç–æ–ø—è—Ç–æ–≤",
            "–ò–ü –ó—è–±–ª–∏—Ü–∫–∏–π",
            "–ò–ü –ë–∞–≥–ª–∏–∫–æ–≤",
            "–ò–ü –°—Ç–µ–ø–∞–Ω–æ–≤",
            "–ò–ü –ì–ª—É–º–µ–Ω–∫–æ",
            "–°–ö –°–µ—Ç–∏",
            "–ò–ü –ò–≤–∞—à–∏–Ω"
        ];

        let selectedOrganization = null;
        let selectedDepartment = null;
        let customOrganization = null;
        let customDepartment = null;

        // –û—Å–Ω–æ–≤–Ω—ã–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –¥–ª—è –≥–ª–∞–≤–Ω–æ–π —Å–µ—Ç–∫–∏
        const mainOrganizations = [
            "–ì–ö –°–æ—é–∑",
            "–°–æ—é–∑-–ò–Ω–≤–µ—Å—Ç",
            "–°–ø–µ—Ü—Å—Ç—Ä–æ–π",
            "–°–ø–µ—Ü—Å—Ç—Ä–æ–π-–ù–°–ö",
            "–°–æ—é–∑-–ò–Ω–∂–∏–Ω–∏—Ä–∏–Ω–≥",
            "–°–æ—é–∑-–º–∞—Ä–∫–µ—Ç",
            "–û–ø–æ—Ä–∞",
            "–í–µ—Ä—Ç–∏–∫–∞–ª—å"
        ];

        function initApp() {
            renderMainOrganizations();
            updateSelectionDisplay();
            updateConfirmButton();
        }

        function renderMainOrganizations() {
            const grid = document.getElementById('organizationsGrid');
            grid.innerHTML = '';

            mainOrganizations.forEach(orgName => {
                const org = organizations.find(o =>
                    typeof o === 'string' ? o === orgName : o.name === orgName
                );
                const button = createOrganizationButton(org);
                grid.appendChild(button);
            });
        }

        function createOrganizationButton(org) {
            const orgName = typeof org === 'string' ? org : org.name;
            const button = document.createElement('button');
            button.className = 'organization-button';

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—ã–±—Ä–∞–Ω–∞ –ª–∏ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è
            let isSelected = false;
            if (selectedOrganization) {
                if (typeof selectedOrganization === 'string') {
                    isSelected = selectedOrganization === orgName;
                } else if (selectedOrganization.name) {
                    isSelected = selectedOrganization.name === orgName;
                }
            }

            if (isSelected) {
                button.classList.add('selected');
            }

            button.textContent = orgName;
            button.onclick = () => selectOrganization(org);
            return button;
        }

        function filterOrganizations() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const grid = document.getElementById('organizationsGrid');
            grid.innerHTML = '';

            if (searchTerm === '') {
                renderMainOrganizations();
                return;
            }

            // –§–∏–ª—å—Ç—Ä—É–µ–º –≤—Å–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –ø–æ –ø–æ–∏—Å–∫—É
            const filteredOrgs = organizations.filter(org => {
                const orgName = typeof org === 'string' ? org : org.name;
                return orgName.toLowerCase().includes(searchTerm);
            });

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤—ã–µ 12 —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
            filteredOrgs.slice(0, 12).forEach(org => {
                const button = createOrganizationButton(org);
                grid.appendChild(button);
            });

            // –ï—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ
            if (filteredOrgs.length === 0) {
                const noResults = document.createElement('div');
                noResults.className = 'organization-button';
                noResults.textContent = '–ù–µ –Ω–∞–π–¥–µ–Ω–æ';
                noResults.style.opacity = '0.5';
                noResults.style.cursor = 'default';
                grid.appendChild(noResults);
            }
        }

        function showFullList() {
            const modal = document.getElementById('fullListModal');
            const grid = document.getElementById('fullListGrid');
            grid.innerHTML = '';

            organizations.forEach(org => {
                const orgName = typeof org === 'string' ? org : org.name;
                const button = document.createElement('button');
                button.className = 'full-list-button';

                let isSelected = false;
                if (selectedOrganization) {
                    if (typeof selectedOrganization === 'string') {
                        isSelected = selectedOrganization === orgName;
                    } else if (selectedOrganization.name) {
                        isSelected = selectedOrganization.name === orgName;
                    }
                }

                if (isSelected) {
                    button.classList.add('selected');
                }

                button.textContent = orgName;
                button.onclick = () => {
                    selectOrganization(org);
                    hideFullList();
                };
                grid.appendChild(button);
            });

            modal.style.display = 'flex';
        }

        function hideFullList() {
            document.getElementById('fullListModal').style.display = 'none';
            document.getElementById('searchInput').value = '';
            filterOrganizations();
        }

        function selectOrganization(org) {
            selectedOrganization = org;
            customOrganization = null;
            selectedDepartment = null;
            customDepartment = null;

            // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞ —Å–≤–æ–µ–π –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏
            document.getElementById('customOrganizationInput').value = '';

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—ã–±–æ—Ä –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
            const departmentSelection = document.getElementById('departmentSelection');
            const departmentHeader = document.getElementById('departmentHeader');

            if (typeof org === 'object' && org.hasDepartments) {
                departmentSelection.style.display = 'block';
                departmentHeader.textContent = `–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ ${org.name}:`;
                renderDepartments(org.departments);
                document.getElementById('customDepartmentInput').value = '';
            } else {
                departmentSelection.style.display = 'none';
            }

            updateSelectionDisplay();
            renderMainOrganizations();
            updateConfirmButton();
        }

        function renderDepartments(departments) {
            const grid = document.getElementById('departmentsGrid');
            grid.innerHTML = '';

            departments.forEach(dept => {
                const button = document.createElement('button');
                button.className = 'department-button';
                if (selectedDepartment === dept && !customDepartment) {
                    button.classList.add('selected');
                }
                button.textContent = dept;
                button.onclick = () => selectDepartment(dept);
                grid.appendChild(button);
            });
        }

        function selectDepartment(dept) {
            selectedDepartment = dept;
            customDepartment = null;
            document.getElementById('customDepartmentInput').value = '';
            renderDepartments(selectedOrganization.departments);
            updateSelectionDisplay();
            updateConfirmButton();
        }

        function updateCustomOrganization() {
            const input = document.getElementById('customOrganizationInput');
            const value = input.value.trim();

            if (value && value.length > 0) {
                customOrganization = value;
                selectedOrganization = null;
                selectedDepartment = null;
                customDepartment = null;

                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—é –∏–∑ —Å–ø–∏—Å–∫–∞
                renderMainOrganizations();

                // –°–∫—Ä—ã–≤–∞–µ–º –≤—ã–±–æ—Ä –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è
                document.getElementById('departmentSelection').style.display = 'none';

                // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –ø–æ–∏—Å–∫–∞
                document.getElementById('searchInput').value = '';
                filterOrganizations();
            } else {
                customOrganization = null;
            }

            updateSelectionDisplay();
            updateConfirmButton();
        }

        function updateCustomDepartment() {
            const input = document.getElementById('customDepartmentInput');
            const value = input.value.trim();

            if (value && value.length > 0) {
                customDepartment = value;
                selectedDepartment = null;
                // –°–Ω–∏–º–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å –∫–Ω–æ–ø–æ–∫ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–π
                renderDepartments(selectedOrganization.departments);
            } else {
                customDepartment = null;
            }

            updateSelectionDisplay();
            updateConfirmButton();
        }

        function updateSelectionDisplay() {
            const orgElement = document.getElementById('selectedOrganization');
            const deptItem = document.getElementById('selectedDepartmentItem');
            const deptElement = document.getElementById('selectedDepartment');
            const customItem = document.getElementById('selectedCustomItem');
            const customElement = document.getElementById('selectedCustom');

            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Å–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
            deptItem.style.display = 'none';
            customItem.style.display = 'none';

            if (customOrganization) {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–≤–æ—é –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—é
                orgElement.textContent = customOrganization;
                customItem.style.display = 'block';
                customElement.textContent = customOrganization;
            } else if (selectedOrganization) {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –∏–∑ —Å–ø–∏—Å–∫–∞
                const orgName = typeof selectedOrganization === 'string'
                    ? selectedOrganization
                    : selectedOrganization.name;
                orgElement.textContent = orgName;

                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –µ—Å–ª–∏ –µ—Å—Ç—å
                if (typeof selectedOrganization === 'object' && selectedOrganization.hasDepartments) {
                    deptItem.style.display = 'block';
                    if (customDepartment) {
                        deptElement.textContent = customDepartment;
                    } else if (selectedDepartment) {
                        deptElement.textContent = selectedDepartment;
                    } else {
                        deptElement.textContent = '–Ω–µ –≤—ã–±—Ä–∞–Ω–æ';
                    }
                }
            } else {
                orgElement.textContent = '–Ω–µ –≤—ã–±—Ä–∞–Ω–∞';
            }
        }

        function updateConfirmButton() {
            const confirmButton = document.getElementById('confirmButton');

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –µ—Å—Ç—å –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è
            if (!selectedOrganization && !customOrganization) {
                confirmButton.disabled = true;
                return;
            }

            // –î–ª—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π —Å –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è–º–∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ
            if (selectedOrganization &&
                typeof selectedOrganization === 'object' &&
                selectedOrganization.hasDepartments &&
                !selectedDepartment &&
                !customDepartment) {
                confirmButton.disabled = true;
            } else {
                confirmButton.disabled = false;
            }
        }

        function confirmSelection() {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è
            if (!selectedOrganization && !customOrganization) {
                showError('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—é');
                return;
            }

            if (selectedOrganization &&
                typeof selectedOrganization === 'object' &&
                selectedOrganization.hasDepartments &&
                !selectedDepartment &&
                !customDepartment) {
                const orgName = selectedOrganization.name;
                showError(`–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –¥–ª—è ${orgName}`);
                return;
            }

            // –§–æ—Ä–º–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
            const data = {};

            if (customOrganization) {
                // –°–≤–æ—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è
                data.organization = customOrganization;
                data.is_custom = true;
            } else {
                // –û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è –∏–∑ —Å–ø–∏—Å–∫–∞
                data.organization = typeof selectedOrganization === 'string'
                    ? selectedOrganization
                    : selectedOrganization.name;
                data.is_custom = false;
            }

            // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –µ—Å–ª–∏ –µ—Å—Ç—å
            if (customDepartment) {
                data.department = customDepartment;
                data.department_is_custom = true;
            } else if (selectedDepartment) {
                data.department = selectedDepartment;
                data.department_is_custom = false;
            }

            console.log('–û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö:', data);

            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ –±–æ—Ç
            if (window.Telegram && Telegram.WebApp && Telegram.WebApp.sendData) {
                Telegram.WebApp.sendData(JSON.stringify(data));
            }

            // –ó–∞–∫—Ä—ã–≤–∞–µ–º Web App
            Telegram.WebApp.close();
        }

        function cancelSelection() {
            Telegram.WebApp.close();
        }

        function showError(message) {
            Telegram.WebApp.showPopup({
                title: '–û—à–∏–±–∫–∞',
                message: message,
                buttons: [{ type: 'ok' }]
            });
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>