<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–í—ã–±–æ—Ä –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –∏ –¥–∞—Ç—ã</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            padding: 16px;
        }

        .container {
            max-width: 100%;
            padding-bottom: 80px;
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
            padding: 20px;
            background: var(--tg-theme-secondary-bg-color, #f0f0f0);
            border-radius: 12px;
        }

        .header h1 {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .header p {
            font-size: 14px;
            color: var(--tg-theme-hint-color, #999999);
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è —Ä–µ–∂–∏–º–∞ –≤—ã–±–æ—Ä–∞ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ */
        #organizationSection .selected-info {
            margin-bottom: 20px;
            padding: 16px;
            background: var(--tg-theme-secondary-bg-color, #f0f0f0);
            border-radius: 12px;
        }

        .selected-item {
            margin-bottom: 8px;
            font-size: 14px;
        }

        .selected-label {
            color: var(--tg-theme-hint-color, #666666);
        }

        .selected-value {
            font-weight: 600;
            color: var(--tg-theme-button-color, #2481cc);
            margin-left: 5px;
        }

        .search-section {
            margin-bottom: 20px;
        }

        .search-input {
            width: 100%;
            padding: 14px;
            border: 2px solid var(--tg-theme-secondary-bg-color, #f0f0f0);
            border-radius: 12px;
            font-size: 16px;
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
        }

        .search-input:focus {
            outline: none;
            border-color: var(--tg-theme-button-color, #2481cc);
        }

        .organizations-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }

        .organization-button {
            padding: 16px 8px;
            border: none;
            border-radius: 12px;
            background: var(--tg-theme-secondary-bg-color, #f0f0f0);
            color: var(--tg-theme-text-color, #000000);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            word-break: break-word;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .organization-button:hover {
            background: var(--tg-theme-hint-color, #e0e0e0);
        }

        .organization-button.selected {
            background: var(--tg-theme-button-color, #2481cc);
            color: var(--tg-theme-button-text-color, #ffffff);
        }

        .department-selection {
            margin-bottom: 20px;
            padding: 20px;
            background: var(--tg-theme-secondary-bg-color, #f0f0f0);
            border-radius: 12px;
        }

        .department-header {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 15px;
            text-align: center;
        }

        .departments-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 8px;
            margin-bottom: 15px;
        }

        .department-button {
            padding: 12px 8px;
            border: none;
            border-radius: 8px;
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .department-button:hover {
            background: var(--tg-theme-hint-color, #f5f5f5);
        }

        .department-button.selected {
            background: var(--tg-theme-button-color, #2481cc);
            color: var(--tg-theme-button-text-color, #ffffff);
        }

        .custom-input-section {
            margin-bottom: 20px;
            padding: 20px;
            background: var(--tg-theme-secondary-bg-color, #f0f0f0);
            border-radius: 12px;
        }

        .custom-input-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 15px;
            text-align: center;
        }

        .custom-input {
            width: 100%;
            padding: 14px;
            border: 2px solid var(--tg-theme-secondary-bg-color, #ddd);
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 15px;
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
        }

        .custom-input:focus {
            outline: none;
            border-color: var(--tg-theme-button-color, #2481cc);
        }

        .custom-input-note {
            font-size: 12px;
            color: var(--tg-theme-hint-color, #666666);
            text-align: center;
            margin-top: 10px;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è —Ä–µ–∂–∏–º–∞ –∫–∞–ª–µ–Ω–¥–∞—Ä—è */
        #calendarSection .selected-info {
            margin-bottom: 20px;
            padding: 16px;
            background: var(--tg-theme-secondary-bg-color, #f0f0f0);
            border-radius: 12px;
        }

        .calendar-section {
            margin-bottom: 20px;
        }

        .month-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 0 10px;
        }

        .month-title {
            font-size: 18px;
            font-weight: 600;
        }

        .nav-button {
            background: none;
            border: none;
            font-size: 24px;
            color: var(--tg-theme-button-color, #2481cc);
            cursor: pointer;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
        }

        .nav-button:hover {
            background: var(--tg-theme-secondary-bg-color, #f0f0f0);
        }

        .weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            margin-bottom: 5px;
        }

        .weekday {
            text-align: center;
            font-size: 12px;
            color: var(--tg-theme-hint-color, #666666);
            padding: 5px;
        }

        .days {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
        }

        .day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            border-radius: 8px;
            background: var(--tg-theme-secondary-bg-color, #f0f0f0);
            color: var(--tg-theme-text-color, #000000);
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .day:hover {
            background: var(--tg-theme-hint-color, #e0e0e0);
        }

        .day.selected {
            background: var(--tg-theme-button-color, #2481cc);
            color: var(--tg-theme-button-text-color, #ffffff);
        }

        .day.disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .day.today {
            border: 2px solid var(--tg-theme-button-color, #2481cc);
        }

        /* –û–±—â–∏–µ —Å—Ç–∏–ª–∏ */
        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        .actions {
            display: flex;
            gap: 12px;
            position: fixed;
            bottom: 16px;
            left: 16px;
            right: 16px;
            background: var(--tg-theme-bg-color, #ffffff);
            padding: 10px 0;
        }

        .action-button {
            flex: 1;
            padding: 16px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .action-button:active {
            transform: scale(0.95);
        }

        .confirm {
            background: var(--tg-theme-button-color, #2481cc);
            color: var(--tg-theme-button-text-color, #ffffff);
        }

        .cancel {
            background: var(--tg-theme-secondary-bg-color, #f0f0f0);
            color: var(--tg-theme-text-color, #000000);
        }

        .confirm:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .confirm:disabled:active {
            transform: none;
        }

        @media (max-width: 480px) {
            .organizations-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .departments-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- –†–µ–∂–∏–º –≤—ã–±–æ—Ä–∞ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ -->
        <div id="organizationSection" class="section">
            <div class="header">
                <h1>–í—ã–±–æ—Ä –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏</h1>
                <p>–í—ã–±–µ—Ä–∏—Ç–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—é –∏–∑ —Å–ø–∏—Å–∫–∞ –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ —Å–≤–æ—é</p>
            </div>

            <div class="selected-info">
                <div class="selected-item">
                    <span class="selected-label">–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è:</span>
                    <span class="selected-value" id="selectedOrganization">–Ω–µ –≤—ã–±—Ä–∞–Ω–∞</span>
                </div>
                <div class="selected-item" id="selectedDepartmentItem" style="display: none;">
                    <span class="selected-label">–ü–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ:</span>
                    <span class="selected-value" id="selectedDepartment">–Ω–µ –≤—ã–±—Ä–∞–Ω–æ</span>
                </div>
            </div>

            <div class="search-section">
                <input type="text"
                       class="search-input"
                       placeholder="üîç –ü–æ–∏—Å–∫ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏..."
                       id="searchInput"
                       onkeyup="filterOrganizations()">
            </div>

            <div class="organizations-grid" id="organizationsGrid">
                <!-- –û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã —á–µ—Ä–µ–∑ JS -->
            </div>

            <div class="department-selection" id="departmentSelection" style="display: none;">
                <div class="department-header" id="departmentHeader">–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ:</div>
                <div class="departments-grid" id="departmentsGrid">
                    <!-- –ü–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã —á–µ—Ä–µ–∑ JS -->
                </div>
                <div class="custom-input-note">
                    –ò–ª–∏ –≤–≤–µ–¥–∏—Ç–µ —Å–≤–æ–µ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –Ω–∏–∂–µ
                </div>
                <input type="text"
                       class="custom-input"
                       placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–≤–æ–µ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ"
                       id="customDepartmentInput"
                       oninput="updateCustomDepartment()">
            </div>

            <div class="custom-input-section">
                <div class="custom-input-title">–ù–µ –Ω–∞—à–ª–∏ —Å–≤–æ—é –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—é?</div>
                <input type="text"
                       class="custom-input"
                       placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Å–≤–æ–µ–π –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏"
                       id="customOrganizationInput"
                       oninput="updateCustomOrganization()">
                <div class="custom-input-note">
                    –í–∞—à–∞ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ —Å–ø–∏—Å–æ–∫ –≤—ã–±–æ—Ä–∞
                </div>
            </div>
        </div>

        <!-- –†–µ–∂–∏–º –∫–∞–ª–µ–Ω–¥–∞—Ä—è -->
        <div id="calendarSection" class="section">
            <div class="header">
                <h1 id="calendarTitle">–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É</h1>
                <p>–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É –∏–∑ –∫–∞–ª–µ–Ω–¥–∞—Ä—è –Ω–∏–∂–µ</p>
            </div>

            <div class="selected-info">
                <div class="selected-item">
                    <span class="selected-label">–í—ã–±—Ä–∞–Ω–Ω–∞—è –¥–∞—Ç–∞:</span>
                    <span class="selected-value" id="selectedDate">–Ω–µ –≤—ã–±—Ä–∞–Ω–∞</span>
                </div>
            </div>

            <div class="calendar-section">
                <div class="month-header">
                    <button class="nav-button" onclick="changeMonth(-1)">‚Üê</button>
                    <div class="month-title" id="currentMonth"></div>
                    <button class="nav-button" onclick="changeMonth(1)">‚Üí</button>
                </div>

                <div class="weekdays">
                    <div class="weekday">–ü–Ω</div>
                    <div class="weekday">–í—Ç</div>
                    <div class="weekday">–°—Ä</div>
                    <div class="weekday">–ß—Ç</div>
                    <div class="weekday">–ü—Ç</div>
                    <div class="weekday">–°–±</div>
                    <div class="weekday">–í—Å</div>
                </div>

                <div class="days" id="calendarDays">
                    <!-- –î–Ω–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã —á–µ—Ä–µ–∑ JS -->
                </div>
            </div>
        </div>
    </div>

    <div class="actions">
        <button class="action-button cancel" onclick="cancelSelection()">–û—Ç–º–µ–Ω–∞</button>
        <button class="action-button confirm" id="confirmButton" onclick="confirmSelection()" disabled>–í—ã–±—Ä–∞—Ç—å</button>
    </div>

    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram Web App
        Telegram.WebApp.ready();
        Telegram.WebApp.expand();

        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä–µ–∂–∏–º –∏–∑ URL –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
        const urlParams = new URLSearchParams(window.location.search);
        const mode = urlParams.get('mode') || 'calendar'; // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –∫–∞–ª–µ–Ω–¥–∞—Ä—å

        // –¢–µ–∫—É—â–∏–π —Ä–µ–∂–∏–º
        let currentMode = mode; // 'organization' –∏–ª–∏ 'calendar'
        let selectedDate = null;
        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();

        // –ü–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è –¥–ª—è –°–ø–µ—Ü—Å—Ç—Ä–æ–π-–ù–°–ö
        const specstroyNskDepartments = [
            "–°—Ç—Ä–æ–∏—Ç–µ–ª—å–Ω–æ-–º–æ–Ω—Ç–∞–∂–Ω—ã–π —É—á–∞—Å—Ç–æ–∫ - 1",
            "–°—Ç—Ä–æ–∏—Ç–µ–ª—å–Ω–æ-–º–æ–Ω—Ç–∞–∂–Ω—ã–π —É—á–∞—Å—Ç–æ–∫ - 2",
            "–°—Ç—Ä–æ–∏—Ç–µ–ª—å–Ω–æ-–º–æ–Ω—Ç–∞–∂–Ω—ã–π —É—á–∞—Å—Ç–æ–∫ - 3",
            "–°—Ç—Ä–æ–∏—Ç–µ–ª—å–Ω–æ-–º–æ–Ω—Ç–∞–∂–Ω—ã–π —É—á–∞—Å—Ç–æ–∫ - 4",
            "–£—á–∞—Å—Ç–æ–∫ –ø–æ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—é –≥—Ä—É–∑–æ–ø–æ–¥—ä–µ–º–Ω—ã—Ö –º–µ—Ö–∞–Ω–∏–∑–º–æ–≤",
            "–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω—ã–π —É—á–∞—Å—Ç–æ–∫",
            "–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω–æ-—É–ø—Ä–∞–≤–ª–µ–Ω—á–µ—Å–∫–æ–µ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ",
            "–°—Ç—Ä–æ–∏—Ç–µ–ª—å–Ω–æ-–º–æ–Ω—Ç–∞–∂–Ω—ã–π —É—á–∞—Å—Ç–æ–∫ (–ê–£–ü)",
            "–ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω–æ-—Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –æ—Ç–¥–µ–ª",
            "–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω–æ-—Ö–æ–∑—è–π—Å—Ç–≤–µ–Ω–Ω—ã–π –æ—Ç–¥–µ–ª",
            "–û—Ç–¥–µ–ª –≥–ª–∞–≤–Ω–æ–≥–æ —ç–Ω–µ—Ä–≥–µ—Ç–∏–∫–∞",
            "–°–ª—É–∂–±–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏"
        ];

        // –î–∞–Ω–Ω—ã–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π
        const organizations = [
            "–ì–ö –°–æ—é–∑",
            "–°–æ—é–∑-–ò–Ω–≤–µ—Å—Ç",
            "–°–ø–µ—Ü—Å—Ç—Ä–æ–π",
            {
                name: "–°–ø–µ—Ü—Å—Ç—Ä–æ–π-–ù–°–ö",
                hasDepartments: true,
                departments: specstroyNskDepartments
            },
            "–°–æ—é–∑-–ò–Ω–∂–∏–Ω–∏—Ä–∏–Ω–≥",
            "–°–æ—é–∑-–º–∞—Ä–∫–µ—Ç",
            "–û–ø–æ—Ä–∞",
            "–í–µ—Ä—Ç–∏–∫–∞–ª—å",
            "–°–ø–µ—Ü—Ç–µ—Ö–Ω–∏–∫–∞",
            "–°–∏–ª–∞ —Ç–æ–∫–∞",
            "–û–ú–¢–°",
            "–ê–ª—å—Ç—Å—Ç—Ä–æ–π",
            "–ù–ö–ñ–ë–ò-2",
            "–ó–ö–ú –°–æ—é–∑",
            "–ñ–ë–ò –ù–°–ö",
            "–°—Ç—Ä–æ–π—Ü–µ–Ω—Ç—Ä",
            "–Æ–Ω–∏–æ–Ω-–º–µ—Ç–∞–ª",
            "–ò–ü –ú–µ–ª—å–Ω–∏–∫",
            "–ò–ü –ú–µ–ª–µ—Ö–æ–≤",
            "–ú–µ–ª–µ—Ö–æ–≤ (–¥–æ–ø)",
            "–ò–ü –Ø—Ä–æ—Ö",
            "–ò–ü –¢–∞—Ä–∞—Å–æ–≤",
            "–ò–ü –¢–æ–ª—Å—Ç–æ–ø—è—Ç–æ–≤",
            "–ò–ü –ó—è–±–ª–∏—Ü–∫–∏–π",
            "–ò–ü –ë–∞–≥–ª–∏–∫–æ–≤",
            "–ò–ü –°—Ç–µ–ø–∞–Ω–æ–≤",
            "–ò–ü –ì–ª—É–º–µ–Ω–∫–æ",
            "–°–ö –°–µ—Ç–∏",
            "–ò–ü –ò–≤–∞—à–∏–Ω"
        ];

        let selectedOrganization = null;
        let selectedDepartment = null;
        let customOrganization = null;
        let customDepartment = null;

        // –û—Å–Ω–æ–≤–Ω—ã–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –¥–ª—è –≥–ª–∞–≤–Ω–æ–π —Å–µ—Ç–∫–∏
        const mainOrganizations = [
            "–ì–ö –°–æ—é–∑",
            "–°–æ—é–∑-–ò–Ω–≤–µ—Å—Ç",
            "–°–ø–µ—Ü—Å—Ç—Ä–æ–π",
            "–°–ø–µ—Ü—Å—Ç—Ä–æ–π-–ù–°–ö",
            "–°–æ—é–∑-–ò–Ω–∂–∏–Ω–∏—Ä–∏–Ω–≥",
            "–°–æ—é–∑-–º–∞—Ä–∫–µ—Ç",
            "–û–ø–æ—Ä–∞",
            "–í–µ—Ä—Ç–∏–∫–∞–ª—å",
            "–°–ø–µ—Ü—Ç–µ—Ö–Ω–∏–∫–∞"
        ];

        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è
        const monthNames = [
            "–Ø–Ω–≤–∞—Ä—å", "–§–µ–≤—Ä–∞–ª—å", "–ú–∞—Ä—Ç", "–ê–ø—Ä–µ–ª—å", "–ú–∞–π", "–ò—é–Ω—å",
            "–ò—é–ª—å", "–ê–≤–≥—É—Å—Ç", "–°–µ–Ω—Ç—è–±—Ä—å", "–û–∫—Ç—è–±—Ä—å", "–ù–æ—è–±—Ä—å", "–î–µ–∫–∞–±—Ä—å"
        ];

        function initApp() {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω—É–∂–Ω—É—é —Å–µ–∫—Ü–∏—é –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–µ–∂–∏–º–∞
            if (currentMode === 'organization') {
                document.getElementById('organizationSection').classList.add('active');
                initOrganizationMode();
            } else {
                document.getElementById('calendarSection').classList.add('active');
                initCalendarMode();
            }

            updateConfirmButton();
        }

        function initOrganizationMode() {
            renderMainOrganizations();
            updateSelectionDisplay();
            document.title = "–í—ã–±–æ—Ä –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏";
        }

        function initCalendarMode() {
            updateCalendar();
            document.title = "–í—ã–±–æ—Ä –¥–∞—Ç—ã";
        }

        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏
        function renderMainOrganizations() {
            const grid = document.getElementById('organizationsGrid');
            grid.innerHTML = '';

            mainOrganizations.forEach(orgName => {
                const org = organizations.find(o =>
                    typeof o === 'string' ? o === orgName : o.name === orgName
                );
                const button = createOrganizationButton(org);
                grid.appendChild(button);
            });
        }

        function createOrganizationButton(org) {
            const orgName = typeof org === 'string' ? org : org.name;
            const button = document.createElement('button');
            button.className = 'organization-button';

            let isSelected = false;
            if (selectedOrganization) {
                if (typeof selectedOrganization === 'string') {
                    isSelected = selectedOrganization === orgName;
                } else if (selectedOrganization.name) {
                    isSelected = selectedOrganization.name === orgName;
                }
            }

            if (isSelected) {
                button.classList.add('selected');
            }

            button.textContent = orgName;
            button.onclick = () => selectOrganization(org);
            return button;
        }

        function filterOrganizations() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const grid = document.getElementById('organizationsGrid');
            grid.innerHTML = '';

            if (searchTerm === '') {
                renderMainOrganizations();
                return;
            }

            const filteredOrgs = organizations.filter(org => {
                const orgName = typeof org === 'string' ? org : org.name;
                return orgName.toLowerCase().includes(searchTerm);
            });

            if (filteredOrgs.length > 0) {
                filteredOrgs.forEach(org => {
                    const button = createOrganizationButton(org);
                    grid.appendChild(button);
                });
            } else {
                const noResults = document.createElement('div');
                noResults.className = 'organization-button';
                noResults.textContent = '–ù–µ –Ω–∞–π–¥–µ–Ω–æ';
                noResults.style.opacity = '0.5';
                noResults.style.cursor = 'default';
                grid.appendChild(noResults);
            }
        }

        function selectOrganization(org) {
            selectedOrganization = org;
            customOrganization = null;
            selectedDepartment = null;
            customDepartment = null;

            document.getElementById('customOrganizationInput').value = '';

            const departmentSelection = document.getElementById('departmentSelection');
            const departmentHeader = document.getElementById('departmentHeader');

            if (typeof org === 'object' && org.name === "–°–ø–µ—Ü—Å—Ç—Ä–æ–π-–ù–°–ö" && org.hasDepartments) {
                departmentSelection.style.display = 'block';
                departmentHeader.textContent = `–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ ${org.name}:`;
                renderDepartments(org.departments);
                document.getElementById('customDepartmentInput').value = '';
            } else {
                departmentSelection.style.display = 'none';
            }

            updateSelectionDisplay();
            renderMainOrganizations();
            updateConfirmButton();
        }

        function renderDepartments(departments) {
            const grid = document.getElementById('departmentsGrid');
            grid.innerHTML = '';

            departments.forEach(dept => {
                const button = document.createElement('button');
                button.className = 'department-button';
                if (selectedDepartment === dept && !customDepartment) {
                    button.classList.add('selected');
                }
                button.textContent = dept;
                button.onclick = () => selectDepartment(dept);
                grid.appendChild(button);
            });
        }

        function selectDepartment(dept) {
            selectedDepartment = dept;
            customDepartment = null;
            document.getElementById('customDepartmentInput').value = '';
            renderDepartments(selectedOrganization.departments);
            updateSelectionDisplay();
            updateConfirmButton();
        }

        function updateCustomOrganization() {
            const input = document.getElementById('customOrganizationInput');
            const value = input.value.trim();

            if (value && value.length > 0) {
                customOrganization = value;
                selectedOrganization = null;
                selectedDepartment = null;
                customDepartment = null;

                renderMainOrganizations();
                document.getElementById('departmentSelection').style.display = 'none';
                document.getElementById('searchInput').value = '';
                filterOrganizations();
            } else {
                customOrganization = null;
            }

            updateSelectionDisplay();
            updateConfirmButton();
        }

        function updateCustomDepartment() {
            const input = document.getElementById('customDepartmentInput');
            const value = input.value.trim();

            if (value && value.length > 0) {
                customDepartment = value;
                selectedDepartment = null;
                if (selectedOrganization && selectedOrganization.departments) {
                    renderDepartments(selectedOrganization.departments);
                }
            } else {
                customDepartment = null;
            }

            updateSelectionDisplay();
            updateConfirmButton();
        }

        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è
        function updateCalendar() {
            const monthTitle = document.getElementById('currentMonth');
            const daysContainer = document.getElementById('calendarDays');

            monthTitle.textContent = `${monthNames[currentMonth]} ${currentYear}`;
            daysContainer.innerHTML = '';

            const firstDay = new Date(currentYear, currentMonth, 1);
            const lastDay = new Date(currentYear, currentMonth + 1, 0);
            const daysInMonth = lastDay.getDate();
            const firstDayIndex = firstDay.getDay();

            // –ü—É—Å—Ç—ã–µ —è—á–µ–π–∫–∏ –¥–ª—è –ø–µ—Ä–≤–æ–≥–æ –¥–Ω—è –Ω–µ–¥–µ–ª–∏
            for (let i = 0; i < (firstDayIndex === 0 ? 6 : firstDayIndex - 1); i++) {
                const emptyDay = document.createElement('div');
                emptyDay.className = 'day disabled';
                daysContainer.appendChild(emptyDay);
            }

            // –î–Ω–∏ –º–µ—Å—è—Ü–∞
            const today = new Date();
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(currentYear, currentMonth, day);
                const dayButton = document.createElement('button');
                dayButton.className = 'day';

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–µ–≥–æ–¥–Ω—è—à–Ω–∏–π –¥–µ–Ω—å
                if (date.getDate() === today.getDate() &&
                    date.getMonth() === today.getMonth() &&
                    date.getFullYear() === today.getFullYear()) {
                    dayButton.classList.add('today');
                }

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π –¥–µ–Ω—å
                if (selectedDate &&
                    date.getDate() === selectedDate.getDate() &&
                    date.getMonth() === selectedDate.getMonth() &&
                    date.getFullYear() === selectedDate.getFullYear()) {
                    dayButton.classList.add('selected');
                }

                dayButton.textContent = day;
                dayButton.onclick = () => selectDate(date);
                daysContainer.appendChild(dayButton);
            }
        }

        function changeMonth(delta) {
            currentMonth += delta;
            if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            } else if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            }
            updateCalendar();
        }

        function selectDate(date) {
            selectedDate = date;
            updateCalendar();

            // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞—Ç—É –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
            const formattedDate = date.toLocaleDateString('ru-RU', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            }).replace(/\//g, '.');

            document.getElementById('selectedDate').textContent = formattedDate;
            updateConfirmButton();
        }

        function updateSelectionDisplay() {
            const orgElement = document.getElementById('selectedOrganization');
            const deptItem = document.getElementById('selectedDepartmentItem');
            const deptElement = document.getElementById('selectedDepartment');

            deptItem.style.display = 'none';

            if (customOrganization) {
                orgElement.textContent = customOrganization;
            } else if (selectedOrganization) {
                const orgName = typeof selectedOrganization === 'string'
                    ? selectedOrganization
                    : selectedOrganization.name;
                orgElement.textContent = orgName;

                if (typeof selectedOrganization === 'object' &&
                    selectedOrganization.name === "–°–ø–µ—Ü—Å—Ç—Ä–æ–π-–ù–°–ö" &&
                    selectedOrganization.hasDepartments) {
                    deptItem.style.display = 'block';
                    if (customDepartment) {
                        deptElement.textContent = customDepartment;
                    } else if (selectedDepartment) {
                        deptElement.textContent = selectedDepartment;
                    } else {
                        deptElement.textContent = '–Ω–µ –≤—ã–±—Ä–∞–Ω–æ';
                    }
                }
            } else {
                orgElement.textContent = '–Ω–µ –≤—ã–±—Ä–∞–Ω–∞';
            }
        }

        function updateConfirmButton() {
            const confirmButton = document.getElementById('confirmButton');

            if (currentMode === 'organization') {
                if (!selectedOrganization && !customOrganization) {
                    confirmButton.disabled = true;
                    return;
                }

                if (selectedOrganization &&
                    typeof selectedOrganization === 'object' &&
                    selectedOrganization.name === "–°–ø–µ—Ü—Å—Ç—Ä–æ–π-–ù–°–ö" &&
                    selectedOrganization.hasDepartments &&
                    !selectedDepartment &&
                    !customDepartment) {
                    confirmButton.disabled = true;
                } else {
                    confirmButton.disabled = false;
                }
            } else if (currentMode === 'calendar') {
                confirmButton.disabled = !selectedDate;
            }
        }

        function confirmSelection() {
            let data = {};

            if (currentMode === 'organization') {
                if (!selectedOrganization && !customOrganization) {
                    showError('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—é');
                    return;
                }

                if (selectedOrganization &&
                    typeof selectedOrganization === 'object' &&
                    selectedOrganization.name === "–°–ø–µ—Ü—Å—Ç—Ä–æ–π-–ù–°–ö" &&
                    selectedOrganization.hasDepartments &&
                    !selectedDepartment &&
                    !customDepartment) {
                    showError('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –¥–ª—è –°–ø–µ—Ü—Å—Ç—Ä–æ–π-–ù–°–ö');
                    return;
                }

                if (customOrganization) {
                    data.organization = customOrganization;
                    if (customDepartment) {
                        data.department = customDepartment;
                    }
                } else {
                    data.organization = typeof selectedOrganization === 'string'
                        ? selectedOrganization
                        : selectedOrganization.name;
                    if (selectedDepartment || customDepartment) {
                        data.department = customDepartment || selectedDepartment;
                    }
                }
            } else if (currentMode === 'calendar') {
                if (!selectedDate) {
                    showError('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É');
                    return;
                }
                data.date = selectedDate.toLocaleDateString('ru-RU', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric'
                }).replace(/\//g, '.');
            }

            console.log('–û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö:', data);

            if (window.Telegram && Telegram.WebApp && Telegram.WebApp.sendData) {
                Telegram.WebApp.sendData(JSON.stringify(data));
            }

            Telegram.WebApp.close();
        }

        function cancelSelection() {
            Telegram.WebApp.close();
        }

        function showError(message) {
            Telegram.WebApp.showPopup({
                title: '–û—à–∏–±–∫–∞',
                message: message,
                buttons: [{ type: 'ok' }]
            });
        }

        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>